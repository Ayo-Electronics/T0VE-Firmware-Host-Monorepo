syntax = "proto3";

//some BULLSHIT here
//Apparently any uppercase letters in the package name cause code generation to fail????
//https://github.com/danielgtaylor/python-betterproto/issues/562
//https://github.com/danielgtaylor/python-betterproto/issues/437
package app;  

//========================== SHARED "TYPES" ==========================
//the most standards-compliant way to define fixed-sized arrays, but also define them as optional
//involves wrapping them in a message. Annoying, but it works.
//sizes set in .options file
message uint32_2 {
  repeated uint32 values = 1;
}

message uint32_4 {
  repeated uint32 values = 1;
}

message uint32_10 {
  repeated uint32 values = 1;
}

message bool_4 {
  repeated bool values = 1;
}

//========================== DEBUG MESSAGES ==========================

enum Debug_Level {
  INFO =    0;
  WARNING = 1;
  ERROR =   2;
}

message Debug {
  Debug_Level level =  1;
  string msg =         2; //max length set in .options file, 256 
}

//========================== NODE STATE MESSAGES ==========================

//### STATE SUPERVISOR ###
message State_Supervisor_Status {
  bool decode_err =             1;
  uint32 decode_err_deserz =    2;
  uint32 decode_err_magic =     3;
  uint32 decode_err_msgtype =   4;
  bool encode_err =             5;
  uint32 encode_err_serz =      6;
}

message State_Supervisor {
  State_Supervisor_Status status =    1;
  //no commands
}

//### MULTICARD INFORMATION ###
message Multicard_Status {
  bool all_present =       1;
  uint32 node_id =         2;
}

message Multicard_Command {
  optional bool sel_pd_input_aux_npic = 1;
}

message Multicard {
  Multicard_Status status = 1;
  Multicard_Command command = 2;
}

//### POWER MONITOR ###
message PM_Status {
  bool immediate_power_status = 1;
  bool debounced_power_status = 2;
}

message PM_Command {
  optional bool regulator_enable = 1;
}

message PM {
  PM_Status status =    1;
  PM_Command command =  2;
}

//### ADC OFFSET CONTROL ###

message Offset_Ctrl_Status {
  bool device_present =              1;
  bool device_error =                2;
  uint32_4 offset_readback =         3; //array of 4 uint32s
}

message Offset_Ctrl_Command {
  optional bool do_readback =     1;
  optional uint32_4 offset_set =  2;
}

message Offset_Ctrl {
  Offset_Ctrl_Status status =    1;
  Offset_Ctrl_Command command =  2;
}

//### HISPEED SUBSYSTEM ###
message Hispeed_Status {
  bool armed =                1;
  bool done_success =         2;
  bool done_err_ready =       3;
  bool done_err_timeout =     4;
  bool done_err_pwr =         5;
  bool done_err_cancelled =   6;
  uint32_4 tia_adc_readback = 7;
}

message Hispeed_Command {
  optional bool arm_request =         1;
  optional bool_4 SOA_enable =        2;
  optional bool_4 TIA_enable =        3;
  optional uint32_4 SOA_DAC_drive =   4;
}

message Hispeed {
  Hispeed_Status status =    1;
  Hispeed_Command command =  2;
}

//### CoB TEMPERATURE ###
message CoB_Temp_Status {
  bool device_present =        1;
  bool device_error =          2;
  uint32 device_id =           3;
  float temperature_celsius =  4;
}

//no commands for the CoB temperature sensor

message CoB_Temp {
  CoB_Temp_Status status =    1;
  //no commands
}

//### CoB EEPROM ###
message CoB_EEPROM_Status {
  bool device_present =  1;
  bool device_error =    2;
  uint32 cob_UID =       3;
  string cob_desc =      4; //max length set in .options file, 128
}

message CoB_EEPROM_Command {
  optional bool do_cob_write_desc = 1;
  optional string cob_desc_set =    2; //max length set in .options file, 128
  optional uint32 cob_write_key =   3;
}

message CoB_EEPROM {
  CoB_EEPROM_Status status =    1;
  CoB_EEPROM_Command command =  2;
}

//### WAVEGUIDE BIAS DRIVES ###
message WG_Bias_Setpoints {
  uint32_10 stub_setpoint = 1;
  uint32_4 mid_setpoint =   2;
  uint32_2 bulk_setpoint =  3;
}

message WG_Bias_Status {
  bool device_present =                  1;
  bool device_error =                    2;
  WG_Bias_Setpoints setpoints_readback = 3;
}

message WG_Bias_Command {
  optional WG_Bias_Setpoints setpoints =  1;
  optional bool regulator_enable =        2;   
  optional bool do_readback =             3;
}

message WG_Bias {
  WG_Bias_Status status =    1;
  WG_Bias_Command command =  2;
}

//### NEURAL MEMORY INTERFACE ###
message Neural_Mem_Status {
  uint32 detected_input_size =  1;
  uint32 detected_output_size = 2;
  bool mem_attached =           3;
}

message Neural_Mem_Command {
  optional bool check_io_size          = 1;
  optional uint32 load_test_pattern    = 2;
}

message Neural_Mem {
  Neural_Mem_Status status =    1;
  Neural_Mem_Command command =  2;
}

//### COMMS INTERFACE ###
message Comms_Status {
  bool comms_connected = 1;
}

message Comms_Command {
  optional bool allow_connection = 1;
}

message Comms {
  Comms_Status status =    1;
  Comms_Command command =  2;
}

//########### STATE AGGREGATION ###########

message Node_State {
  State_Supervisor state_supervisor = 1;
  Multicard multicard =               2;
  PM pm_onboard =                     3;
  PM pm_motherboard =                 4;
  Offset_Ctrl offset_ctrl =           5;
  Hispeed hispeed =                   6;
  CoB_Temp cob_temp =                 7;
  CoB_EEPROM cob_eeprom =             8;
  WG_Bias waveguide_bias =            9;
  Neural_Mem neural_mem_manager =     10;
  Comms comms =                       11;
  uint32 MAGIC_NUMBER =               12;
  optional bool do_system_reset =     13;
}

//========================== AGGREGATION INTO SINGLE MESSAGE ==========================

message Communication {
  oneof payload {
    Node_State node_state = 1;
    Debug debug_message =   2;
  }
}